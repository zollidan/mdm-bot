<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>mdm bot ‚Äî –∫–∞—Ç–∞–ª–æ–≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background-color: #fffef9;
        -webkit-tap-highlight-color: transparent;
      }

      .neo-shadow {
        box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 1);
      }

      .neo-shadow-sm {
        box-shadow: 2px 2px 0px 0px rgba(0, 0, 0, 1);
      }

      .neo-press:active {
        transform: translate(2px, 2px);
        box-shadow: none;
      }

      /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .fade-in {
        animation: fadeIn 0.3s ease-out forwards;
      }
    </style>
  </head>
  <body class="text-black antialiased">
    <!-- Header -->
    <header class="sticky top-0 z-50 p-4">
      <nav
        class="flex items-center justify-between bg-white border-2 border-black rounded-2xl p-4 neo-shadow"
      >
        <a href="/" class="flex items-center gap-2 neo-press">
          <div
            class="w-8 h-8 bg-[#FCD34D] border-2 border-black rounded-lg flex items-center justify-center font-extrabold text-sm"
          >
            ‚Üê
          </div>
          <h1 class="text-xl font-extrabold tracking-tight">–∫–∞—Ç–∞–ª–æ–≥</h1>
        </a>
        <div
          id="cart-counter"
          class="bg-black text-white px-3 py-1 rounded-full text-xs font-bold"
        >
          0 –¢–û–í–ê–†–û–í
        </div>
      </nav>
    </header>

    <main class="p-4 space-y-6">
      <!-- Search & Filter Bar -->
      <section class="space-y-3">
        <div class="relative">
          <input
            type="text"
            id="search-input"
            placeholder="–ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
            class="w-full p-4 bg-white border-2 border-black rounded-2xl font-bold placeholder:opacity-50 focus:outline-none focus:ring-2 focus:ring-[#FCD34D] transition-all"
          />
          <div
            class="absolute right-4 top-1/2 -translate-y-1/2 font-black text-xl"
          >
            üîç
          </div>
        </div>

        <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
          <button
            class="px-4 py-2 bg-[#FCD34D] border-2 border-black rounded-xl font-extrabold text-sm whitespace-nowrap neo-press"
          >
            –≤—Å–µ
          </button>
          <button
            class="px-4 py-2 bg-white border-2 border-black rounded-xl font-extrabold text-sm whitespace-nowrap neo-press opacity-50"
          >
            –æ–¥–µ–∂–¥–∞
          </button>
          <button
            class="px-4 py-2 bg-white border-2 border-black rounded-xl font-extrabold text-sm whitespace-nowrap neo-press opacity-50"
          >
            –æ–±—É–≤—å
          </button>
          <button
            class="px-4 py-2 bg-white border-2 border-black rounded-xl font-extrabold text-sm whitespace-nowrap neo-press opacity-50"
          >
            –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã
          </button>
        </div>
      </section>

      <!-- Product Grid -->
      <div id="products-grid" class="grid grid-cols-2 gap-4">
        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç —Ç–æ–≤–∞—Ä—ã -->
        <div class="col-span-2 py-20 text-center animate-pulse">
          <p class="font-extrabold text-xl opacity-20 italic">
            –Ω–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–∫–∏...
          </p>
        </div>
      </div>

      <!-- Pagination -->
      <div id="pagination" class="flex items-center justify-center gap-3 pt-4">
        <!-- –ö–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
      </div>
    </main>

    <script>
      let currentPage = 1;
      const limit = 10;
      let totalPages = 1;

      async function loadProducts(page = 1) {
        currentPage = page;
        const grid = document.getElementById("products-grid");

        try {
          const response = await fetch(
            `/api/products?page=${page}&limit=${limit}`
          );
          const data = await response.json();

          totalPages = data.total_pages;
          renderProducts(data.items);
          renderPagination();

          // Scroll to top on page change
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (error) {
          grid.innerHTML = `
                    <div class="col-span-2 bg-red-100 border-2 border-black rounded-2xl p-6 text-center neo-shadow">
                        <p class="font-bold text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
                    </div>
                `;
        }
      }

      function renderProducts(products) {
        const grid = document.getElementById("products-grid");

        if (products.length === 0) {
          grid.innerHTML = `
                    <div class="col-span-2 bg-white border-2 border-black rounded-2xl p-10 text-center neo-shadow">
                        <p class="font-bold opacity-50 italic text-lg">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏ üïµÔ∏è‚Äç‚ôÇÔ∏è</p>
                    </div>
                `;
          return;
        }

        grid.innerHTML = products
          .map(
            (product, index) => `
                <div class="bg-white border-2 border-black rounded-2xl overflow-hidden neo-shadow flex flex-col fade-in" style="animation-delay: ${
                  index * 0.05
                }s">
                    <a href="/products/${
                      product.id
                    }" class="relative aspect-square bg-gray-50 border-b-2 border-black overflow-hidden group">
                        ${
                          product.image
                            ? `<img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover group-hover:scale-105 transition-transform">`
                            : `<div class="w-full h-full flex items-center justify-center text-4xl">üì¶</div>`
                        }
                        <div class="absolute top-2 left-2 px-2 py-0.5 bg-white border border-black rounded-md text-[10px] font-black uppercase">
                            new
                        </div>
                    </a>
                    <div class="p-3 flex flex-col flex-1 gap-2">
                        <h3 class="font-extrabold text-sm leading-tight line-clamp-2 h-10">${
                          product.name
                        }</h3>
                        <div class="mt-auto pt-2 flex flex-col gap-2">
                            <span class="text-lg font-black leading-none">${product.price.toLocaleString()} ‚ÇΩ</span>
                            <button onclick="addToCart(${
                              product.id
                            })" class="w-full py-2 bg-[#FCD34D] border-2 border-black rounded-xl font-extrabold text-xs uppercase neo-press">
                                –∫—É–ø–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function renderPagination() {
        const container = document.getElementById("pagination");
        let buttons = "";

        // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
        if (currentPage > 1) {
          buttons += `
                    <button onclick="loadProducts(${
                      currentPage - 1
                    })" class="w-10 h-10 bg-white border-2 border-black rounded-xl flex items-center justify-center font-bold neo-shadow-sm neo-press">
                        ‚Äπ
                    </button>
                `;
        }

        // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
        for (
          let i = Math.max(1, currentPage - 1);
          i <= Math.min(totalPages, currentPage + 1);
          i++
        ) {
          const isActive = i === currentPage;
          buttons += `
                    <button onclick="loadProducts(${i})" class="w-10 h-10 ${
            isActive ? "bg-[#FCD34D]" : "bg-white"
          } border-2 border-black rounded-xl flex items-center justify-center font-black neo-shadow-sm neo-press">
                        ${i}
                    </button>
                `;
        }

        // –ö–Ω–æ–ø–∫–∞ –≤–ø–µ—Ä–µ–¥
        if (currentPage < totalPages) {
          buttons += `
                    <button onclick="loadProducts(${
                      currentPage + 1
                    })" class="w-10 h-10 bg-white border-2 border-black rounded-xl flex items-center justify-center font-bold neo-shadow-sm neo-press">
                        ‚Ä∫
                    </button>
                `;
        }

        container.innerHTML = buttons;
      }

      // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã
      let count = 0;
      function addToCart(id) {
        count++;
        document.getElementById("cart-counter").innerText = `${count} –¢–û–í–ê–†–û–í`;
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É Telegram Haptic Feedback
        if (window.Telegram && window.Telegram.WebApp) {
          window.Telegram.WebApp.HapticFeedback.impactOccurred("medium");
        }
      }

      // –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ MeiliSearch
      let searchTimeout;
      document.getElementById("search-input").addEventListener("input", (e) => {
        const query = e.target.value.trim();

        // Debounce –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
        clearTimeout(searchTimeout);

        if (query.length === 0) {
          loadProducts(1); // –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—ã—á–Ω–æ–º—É –∫–∞—Ç–∞–ª–æ–≥—É
          return;
        }

        searchTimeout = setTimeout(async () => {
          if (query.length < 2) return; // –ú–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞

          const grid = document.getElementById("products-grid");
          grid.innerHTML = `
            <div class="col-span-2 py-10 text-center animate-pulse">
              <p class="font-extrabold text-lg opacity-20 italic">–∏—â–µ–º...</p>
            </div>
          `;

          try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=20`);
            const data = await response.json();

            renderProducts(data.items);

            // –°–∫—Ä—ã—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
            document.getElementById("pagination").innerHTML = `
              <p class="text-sm font-bold opacity-50">–ù–∞–π–¥–µ–Ω–æ: ${data.total} —Ç–æ–≤–∞—Ä–æ–≤</p>
            `;
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:", error);
            grid.innerHTML = `
              <div class="col-span-2 bg-red-100 border-2 border-black rounded-2xl p-6 text-center neo-shadow">
                <p class="font-bold text-red-600">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</p>
              </div>
            `;
          }
        }, 300); // –ó–∞–¥–µ—Ä–∂–∫–∞ 300–º—Å
      });

      window.onload = () => loadProducts(1);
    </script>
  </body>
</html>
